{# app/templates/dashboard/bento.html - Modern Bento UI Dashboard for 2025 #}
{% extends "base.html" %}

{% block extra_css %}
<style>
  /* Dashboard specific styles */
  .bento-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    grid-auto-rows: minmax(120px, auto);
    gap: 16px;
    margin-bottom: 24px;
  }

  @media (max-width: 768px) {
    .bento-dashboard {
      grid-template-columns: 1fr;
    }
  }

  .bento-balance {
    grid-column: span 2;
    grid-row: span 1;
  }

  .bento-recent {
    grid-column: span 2;
    grid-row: span 2;
  }

  @media (max-width: 768px) {
    .bento-balance, .bento-recent {
      grid-column: span 1;
      grid-row: span 1;
    }
  }

  .stat-card {
    height: 100%;
    background-color: white;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  }

  .stat-card-header {
    padding: 16px;
    font-size: 1rem;
    color: #333;
    font-weight: 600;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .stat-card-body {
    padding: 16px;
    flex: 1;
  }

  .stats-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .stats-label {
    color: #666;
    font-size: 0.9rem;
  }

  .quick-actions {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  @media (max-width: 768px) {
    .quick-actions {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .quick-action {
    background-color: white;
    border-radius: 16px;
    padding: 16px 12px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: var(--dark-color);
  }

  .quick-action:hover, .quick-action:focus {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    text-decoration: none;
  }

  .quick-action i {
    width: 40px;
    height: 40px;
    background-color: rgba(102, 103, 171, 0.1);
    border-radius: 12px;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    margin-bottom: 8px;
  }

  .quick-action span {
    font-size: 0.8rem;
    font-weight: 500;
  }

  .quick-action.income i {
    background-color: rgba(76, 175, 80, 0.1);
    color: var(--success-color);
  }

  .quick-action.expense i {
    background-color: rgba(244, 67, 54, 0.1);
    color: var(--danger-color);
  }

  .transaction-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .transaction-item:last-child {
    border-bottom: none;
  }

  .transaction-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background-color: rgba(102, 103, 171, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    flex-shrink: 0;
  }

  .transaction-icon.income {
    background-color: rgba(76, 175, 80, 0.1);
    color: var(--success-color);
  }

  .transaction-icon.expense {
    background-color: rgba(244, 67, 54, 0.1);
    color: var(--danger-color);
  }

  .transaction-details {
    flex: 1;
  }

  .transaction-title {
    font-weight: 500;
    margin-bottom: 4px;
  }

  .transaction-subtitle {
    font-size: 0.8rem;
    color: #666;
  }

  .transaction-amount {
    font-weight: 600;
    text-align: right;
  }

  .transaction-date {
    font-size: 0.8rem;
    color: #666;
    text-align: right;
  }

  /* Category pill */
  .category-pill {
    display: inline-flex;
    align-items: center;
    background-color: #f5f5f5;
    color: #333;
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 0.75rem;
    margin-right: 6px;
  }

  .category-pill i {
    margin-right: 4px;
    font-size: 0.7rem;
  }

  /* Mobile bottom nav */
  .mobile-bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: white;
    display: flex;
    justify-content: space-around;
    padding: 12px 0 8px;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    z-index: 1000;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
  }

  .mobile-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: var(--gray-600);
  }

  .mobile-nav-item.active {
    color: var(--primary-color);
  }

  .mobile-nav-item i {
    font-size: 1.2rem;
    margin-bottom: 4px;
  }

  .mobile-nav-item span {
    font-size: 0.7rem;
  }

  /* Floating action button */
  .mobile-fab {
    position: fixed;
    bottom: 70px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 28px;
    background-color: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 1001;
    font-size: 1.5rem;
  }

  .mobile-menu-items {
    position: fixed;
    bottom: 140px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
  }

  .mobile-menu-items.show {
    opacity: 1;
    visibility: visible;
  }

  .mobile-menu-item {
    display: flex;
    align-items: center;
    background-color: white;
    border-radius: 24px;
    padding: 10px 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    text-decoration: none;
    color: var(--dark-color);
  }

  .mobile-menu-item i {
    width: 32px;
    height: 32px;
    border-radius: 16px;
    background-color: rgba(102, 103, 171, 0.1);
    color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
  }

  .mobile-menu-item.income i {
    background-color: rgba(76, 175, 80, 0.1);
    color: var(--success-color);
  }

  .mobile-menu-item.expense i {
    background-color: rgba(244, 67, 54, 0.1);
    color: var(--danger-color);
  }

  /* Animate numbers */
  @keyframes countUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .animate-count {
    animation: countUp 0.5s ease-out forwards;
  }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
  <div class="mb-3">
    <h2 class="mb-3 d-flex align-items-center">
      <i class="fas fa-chart-line text-primary me-2"></i>Dashboard
      <div class="ms-auto d-flex align-items-center">
        <span class="badge rounded-pill bg-primary d-none d-md-inline-block">{{ now.strftime('%B %Y') }}</span>
      </div>
    </h2>
    <p class="text-muted d-none d-md-block">ยินดีต้อนรับกลับ, {{ current_user.username }}! นี่คือสรุปรายรับรายจ่ายของคุณ</p>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <a href="{{ url_for('transactions.create', type='income') }}" class="quick-action income">
      <i class="fas fa-plus"></i>
      <span>รายรับ</span>
    </a>
    <a href="{{ url_for('transactions.create', type='expense') }}" class="quick-action expense">
      <i class="fas fa-minus"></i>
      <span>รายจ่าย</span>
    </a>
    <a href="{{ url_for('accounts.index') }}" class="quick-action">
      <i class="fas fa-wallet"></i>
      <span>บัญชี</span>
    </a>
    <a href="{{ url_for('reports.monthly') }}" class="quick-action">
      <i class="fas fa-chart-pie"></i>
      <span>รายงาน</span>
        </a>
  </div>

  <!-- Main Dashboard Bento Grid -->
  <div class="bento-dashboard">
    <!-- รายรับ -->
    <div class="stat-card">
      <div class="stat-card-header">
        <span><i class="fas fa-hand-holding-usd me-2 text-success"></i>รายรับเดือนนี้</span>
        <span class="badge bg-success">{{ monthly_summary.income|length }} รายการ</span>
      </div>
      <div class="stat-card-body">
        <div class="d-flex flex-column">
          <div class="stats-value text-success counter-animate" data-target="{{ monthly_summary.income }}" data-prefix="" data-suffix=" ฿" data-decimals="2">
            {{ "{:,.2f}".format(monthly_summary.income) }} ฿
          </div>
          <div class="stats-label d-flex align-items-center">
            <span>รอดำเนินการ</span>
            <span class="badge bg-warning text-dark ms-2">+ {{ "{:,.2f}".format(monthly_summary.pending_income) }} ฿</span>
          </div>
        </div>
      </div>
    </div>

    <!-- รายจ่าย -->
    <div class="stat-card">
      <div class="stat-card-header">
        <span><i class="fas fa-shopping-cart me-2 text-danger"></i>รายจ่ายเดือนนี้</span>
        <span class="badge bg-danger">{{ monthly_summary.expense|length }} รายการ</span>
      </div>
      <div class="stat-card-body">
        <div class="d-flex flex-column">
          <div class="stats-value text-danger counter-animate" data-target="{{ monthly_summary.expense }}" data-prefix="" data-suffix=" ฿" data-decimals="2">
            {{ "{:,.2f}".format(monthly_summary.expense) }} ฿
          </div>
          <div class="stats-label d-flex align-items-center">
            <span>รอดำเนินการ</span>
            <span class="badge bg-warning text-dark ms-2">+ {{ "{:,.2f}".format(monthly_summary.pending_expense) }} ฿</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ยอดคงเหลือ -->
    <div class="stat-card bento-balance">
      <div class="stat-card-header">
        <span><i class="fas fa-wallet me-2 text-primary"></i>ยอดคงเหลือ</span>
        <span class="badge bg-primary">{{ now.strftime('%B %Y') }}</span>
      </div>
      <div class="stat-card-body">
        <div class="row">
          <div class="col-6">
            <div class="d-flex flex-column">
              <h6 class="mb-2">ยอดจริง</h6>
              <div class="stats-value {{ 'text-success' if monthly_summary.account_balance >= 0 else 'text-danger' }} counter-animate" data-target="{{ monthly_summary.account_balance }}" data-prefix="" data-suffix=" ฿" data-decimals="2">
                {{ "{:,.2f}".format(monthly_summary.account_balance) }} ฿
              </div>
              <div class="stats-label">ยอดรวมทุกบัญชี</div>
            </div>
          </div>
          <div class="col-6">
            <div class="d-flex flex-column">
              <h6 class="mb-2">คาดการณ์</h6>
              <div class="stats-value {{ 'text-success' if monthly_summary.real_balance >= 0 else 'text-danger' }} counter-animate" data-target="{{ monthly_summary.real_balance }}" data-prefix="" data-suffix=" ฿" data-decimals="2">
                {{ "{:,.2f}".format(monthly_summary.real_balance) }} ฿
              </div>
              <div class="stats-label">รวมรายการรอดำเนินการ</div>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <div class="progress" style="height: 10px; border-radius: 5px;">
            <div class="progress-bar bg-success" style="width: {{ (monthly_summary.income / (monthly_summary.income + monthly_summary.expense) * 100) if (monthly_summary.income + monthly_summary.expense) > 0 else 0 }}%"></div>
            <div class="progress-bar bg-danger" style="width: {{ (monthly_summary.expense / (monthly_summary.income + monthly_summary.expense) * 100) if (monthly_summary.income + monthly_summary.expense) > 0 else 0 }}%"></div>
          </div>
          <div class="d-flex justify-content-between mt-2">
            <small class="text-success">รายรับ {{ "{:.1f}".format((monthly_summary.income / (monthly_summary.income + monthly_summary.expense) * 100)) if (monthly_summary.income + monthly_summary.expense) > 0 else 0 }}%</small>
            <small class="text-danger">รายจ่าย {{ "{:.1f}".format((monthly_summary.expense / (monthly_summary.income + monthly_summary.expense) * 100)) if (monthly_summary.income + monthly_summary.expense) > 0 else 0 }}%</small>
          </div>
        </div>
      </div>
    </div>

    <!-- บัญชี -->
    <div class="stat-card">
      <div class="stat-card-header">
        <span><i class="fas fa-wallet me-2 text-primary"></i>บัญชีของฉัน</span>
        <a href="{{ url_for('accounts.index') }}" class="btn btn-sm btn-outline-primary rounded-pill">ทั้งหมด</a>
      </div>
      <div class="stat-card-body p-0">
        {% if account_balances|length > 0 %}
        <div class="list-group list-group-flush">
          {% for account in account_balances %}
          <div class="list-group-item d-flex justify-content-between align-items-center border-bottom">
            <div>
              <div class="d-flex align-items-center">
                <div class="me-2" style="width: 10px; height: 10px; border-radius: 50%; background-color: var(--primary-color);"></div>
                <h6 class="mb-0">{{ account.name }}</h6>
              </div>
              {% if account.is_active %}
              <small class="text-success"><i class="fas fa-check-circle me-1"></i>ใช้งาน</small>
              {% else %}
              <small class="text-secondary"><i class="fas fa-times-circle me-1"></i>ไม่ใช้งาน</small>
              {% endif %}
            </div>
            <span class="fw-bold {{ 'text-success' if account.balance >= 0 else 'text-danger' }}">
              {{ "{:,.2f}".format(account.balance) }} ฿
            </span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
          <p class="text-muted">ยังไม่มีบัญชี</p>
          <a href="{{ url_for('accounts.create') }}" class="btn btn-sm btn-primary">
            <i class="fas fa-plus me-1"></i> เพิ่มบัญชีใหม่
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- ธุรกรรมล่าสุด -->
    <div class="stat-card bento-recent">
      <div class="stat-card-header">
        <span><i class="fas fa-history me-2 text-primary"></i>ธุรกรรมล่าสุด</span>
        <a href="{{ url_for('transactions.index') }}" class="btn btn-sm btn-outline-primary rounded-pill">ทั้งหมด</a>
      </div>
      <div class="stat-card-body p-0">
        {% if recent_transactions|length > 0 %}
        <div class="transaction-list">
          {% for transaction in recent_transactions %}
          <div class="transaction-item p-3">
            <div class="transaction-icon {{ 'income' if transaction.type == 'income' else 'expense' }}">
              <i class="fas {{ 'fa-arrow-up' if transaction.type == 'income' else 'fa-arrow-down' }}"></i>
            </div>
            <div class="transaction-details">
              <div class="transaction-title">{{ transaction.description or transaction.category.name }}</div>
              <div class="transaction-subtitle">
                <span class="category-pill" style="background-color: {{ transaction.category.color }}20; color: {{ transaction.category.color }};">
                  {% if transaction.category.icon %}
                  <i class="fas fa-{{ transaction.category.icon }}"></i>
                  {% endif %}
                  {{ transaction.category.name }}
                </span>
                <span class="text-muted">{{ transaction.account.name }}</span>
                {% if transaction.status == 'pending' %}
                <span class="badge bg-warning text-dark ms-1">รอ</span>
                {% endif %}
              </div>
            </div>
            <div class="ms-auto text-end">
              <div class="transaction-amount {{ 'text-success' if transaction.type == 'income' else 'text-danger' }}">
                {{ "{:+,.2f}".format(transaction.amount if transaction.type == 'income' else -transaction.amount) }} ฿
              </div>
              <div class="transaction-date">{{ transaction.transaction_date.strftime('%d/%m/%Y') }}</div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
          <p class="text-muted">ยังไม่มีธุรกรรม</p>
          <div class="mt-3 d-flex justify-content-center gap-3">
            <a href="{{ url_for('transactions.create', type='income') }}" class="btn btn-sm btn-success">
              <i class="fas fa-plus-circle me-1"></i> เพิ่มรายได้
            </a>
            <a href="{{ url_for('transactions.create', type='expense') }}" class="btn btn-sm btn-danger">
              <i class="fas fa-minus-circle me-1"></i> เพิ่มรายจ่าย
            </a>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- หมวดหมู่รายจ่าย -->
    <div class="stat-card">
      <div class="stat-card-header">
        <span><i class="fas fa-chart-pie me-2 text-danger"></i>รายจ่ายตามหมวดหมู่</span>
      </div>
      <div class="stat-card-body">
        <div style="height: 200px; position: relative;">
          <canvas id="expenseCategoryChart"></canvas>
          {% if not expense_by_category or expense_by_category|length == 0 %}
          <div class="position-absolute top-0 start-0 end-0 bottom-0 d-flex justify-content-center align-items-center">
            <p class="text-muted">ยังไม่มีข้อมูลรายจ่าย</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Bottom Navigation -->
  <div class="mobile-bottom-nav d-md-none">
    <a href="{{ url_for('dashboard.index') }}" class="mobile-nav-item active">
      <i class="fas fa-home"></i>
      <span>หน้าหลัก</span>
    </a>
    <a href="{{ url_for('transactions.index') }}" class="mobile-nav-item">
      <i class="fas fa-exchange-alt"></i>
      <span>ธุรกรรม</span>
    </a>
    <a href="{{ url_for('accounts.index') }}" class="mobile-nav-item">
      <i class="fas fa-wallet"></i>
      <span>บัญชี</span>
    </a>
    <a href="{{ url_for('reports.monthly') }}" class="mobile-nav-item">
      <i class="fas fa-chart-bar"></i>
      <span>รายงาน</span>
    </a>
  </div>

  <!-- Mobile FAB and Menu Items -->
  <div class="d-md-none">
    <div class="mobile-fab" id="mobile-fab">
      <i class="fas fa-plus"></i>
    </div>

    <div class="mobile-menu-items" id="mobile-menu-items">
      <a href="{{ url_for('transactions.create', type='expense') }}" class="mobile-menu-item expense">
        <i class="fas fa-minus"></i>
        <span>เพิ่มรายจ่าย</span>
      </a>
      <a href="{{ url_for('transactions.create', type='income') }}" class="mobile-menu-item income">
        <i class="fas fa-plus"></i>
        <span>เพิ่มรายรับ</span>
      </a>
      <a href="{{ url_for('categories.index') }}" class="mobile-menu-item">
        <i class="fas fa-tags"></i>
        <span>จัดการหมวดหมู่</span>
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize FAB
    const fabButton = document.getElementById('mobile-fab');
    const menuItems = document.getElementById('mobile-menu-items');

    if (fabButton && menuItems) {
      let isOpen = false;

      fabButton.addEventListener('click', function() {
        isOpen = !isOpen;

        // Toggle icon
        if (isOpen) {
          fabButton.innerHTML = '<i class="fas fa-times"></i>';
          menuItems.classList.add('show');
        } else {
          fabButton.innerHTML = '<i class="fas fa-plus"></i>';
          menuItems.classList.remove('show');
        }
      });

      // Close when clicking outside
      document.addEventListener('click', function(e) {
        if (isOpen && !fabButton.contains(e.target) && !menuItems.contains(e.target)) {
          isOpen = false;
          fabButton.innerHTML = '<i class="fas fa-plus"></i>';
          menuItems.classList.remove('show');
        }
      });
    }

    // Initialize expense category chart if data exists
    {% if expense_by_category and expense_by_category|length > 0 %}
    const expenseCtx = document.getElementById('expenseCategoryChart').getContext('2d');
    new Chart(expenseCtx, {
      type: 'doughnut',
      data: {
        labels: [
          {% for category in expense_by_category %}
          '{{ category.name }}',
          {% endfor %}
        ],
        datasets: [{
          data: [
            {% for category in expense_by_category %}
            {{ category.amount }},
            {% endfor %}
          ],
          backgroundColor: [
            {% for category in expense_by_category %}
            '{{ category.color }}',
            {% endfor %}
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              boxWidth: 10,
              font: {
                size: 10
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${label}: ${value.toLocaleString()} ฿ (${percentage}%)`;
              }
            }
          }
        },
        animation: {
          animateScale: true,
          animateRotate: true
        }
      }
    });
    {% endif %}
  });
</script>
{% endblock %}