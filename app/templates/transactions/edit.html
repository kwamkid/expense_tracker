{% extends "base.html" %}
{% from "macros.html" import render_field, render_submit_button %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-edit me-2"></i>แก้ไขธุรกรรม</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {{ form.csrf_token }}

                    <div class="row">
                        <div class="col-md-6">
                            {{ render_field(form.type) }}
                        </div>
                        <div class="col-md-6">
                            {{ render_field(form.transaction_date) }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            {{ render_field(form.category_id) }}
                        </div>
                        <div class="col-md-6">
                            {{ render_field(form.account_id) }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            {{ render_field(form.amount) }}
                        </div>
                        <div class="col-md-6">
                            {{ render_field(form.status) }}
                        </div>
                    </div>

                    {{ render_field(form.description) }}

                    <div class="mb-3">
                        {{ form.receipt.label(class='form-label') }}
                        {{ form.receipt(class='form-control') }}
                        {% if form.receipt.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.receipt.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if transaction.receipt_path %}
                            <div class="mt-2">
                                <p class="mb-2">ใบเสร็จปัจจุบัน:</p>
                                <img src="{{ url_for('static', filename='uploads/receipts/' + transaction.receipt_path) }}"
                                     class="img-fluid border rounded receipt-thumbnail"
                                     style="max-height: 150px;">
                                <p class="text-muted small mt-1">อัพโหลดไฟล์ใหม่หากต้องการเปลี่ยน</p>
                            </div>
                        {% endif %}
                    </div>

                    <div class="d-flex gap-2">
                        <a href="{{ url_for('transactions.view', id=transaction.id) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i> ยกเลิก
                        </a>
                        {{ form.submit(class='btn btn-primary') }}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>คำแนะนำ</h5>
            </div>
            <div class="card-body">
                <h6>หมายเหตุการแก้ไขธุรกรรม:</h6>
                <ul>
                    <li>การเปลี่ยนประเภทธุรกรรมจะมีผลต่อยอดเงินในบัญชี</li>
                    <li>การเปลี่ยนบัญชีจะทำให้ยอดเงินเปลี่ยนในทั้งบัญชีเก่าและบัญชีใหม่</li>
                    <li>หากเปลี่ยนประเภทจากรายรับเป็นรายจ่ายหรือกลับกัน คุณอาจต้องเปลี่ยนหมวดหมู่ด้วย</li>
                    <li>อัพโหลดไฟล์ใบเสร็จใหม่เฉพาะเมื่อต้องการเปลี่ยนใบเสร็จเดิม</li>
                </ul>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-lightbulb me-2"></i> การแก้ไขถือเป็นการยกเลิกธุรกรรมเดิมและสร้างธุรกรรมใหม่ ดังนั้นยอดเงินในบัญชีจะถูกคำนวณตามการเปลี่ยนแปลงนี้
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // เมื่อประเภทธุรกรรมเปลี่ยน ให้โหลดหมวดหมู่ที่เกี่ยวข้อง
        const transactionTypeSelect = document.getElementById('type');
        const categorySelect = document.getElementById('category_id');

        if (transactionTypeSelect && categorySelect) {
            // ฟังก์ชันโหลดหมวดหมู่
            function loadCategories(type) {
                fetch(`/api/categories?type=${type}`)
                    .then(response => response.json())
                    .then(data => {
                        // ล้างตัวเลือกปัจจุบัน
                        categorySelect.innerHTML = '';

                        // เพิ่มตัวเลือกใหม่
                        data.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            categorySelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading categories:', error));
            }

            // โหลดหมวดหมู่เมื่อประเภทเปลี่ยน
            transactionTypeSelect.addEventListener('change', function() {
                loadCategories(this.value);
            });

            // โหลดหมวดหมู่เริ่มต้น
            if (transactionTypeSelect.value) {
                loadCategories(transactionTypeSelect.value);
            }
        }

        // แสดงตัวอย่างไฟล์ใบเสร็จที่อัพโหลด
        const receiptInput = document.getElementById('receipt');
        const receiptPreview = document.querySelector('.receipt-thumbnail');

        if (receiptInput && receiptPreview) {
            receiptInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        receiptPreview.src = e.target.result;
                        receiptPreview.style.display = 'block';
                    }

                    reader.readAsDataURL(this.files[0]);
                }
            });
        }
    });
</script>
{% endblock %}