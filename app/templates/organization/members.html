{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="mb-3">
            <i class="fas fa-users text-primary me-2"></i>สมาชิกองค์กร {{ organization.name }}
        </h1>
    </div>
   {% if current_user_role == 'admin' %}
    <div class="col-auto">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteLineModal">
            <i class="fab fa-line me-1"></i> เชิญสมาชิกผ่าน LINE
        </button>
    </div>
    {% endif %}
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-user-friends me-2"></i>รายชื่อสมาชิก
        </h5>
        <span class="badge bg-primary">{{ member_roles|length }} คน</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>รูปโปรไฟล์</th>
                        <th>ชื่อผู้ใช้</th>
                        <th>LINE ID</th>
                        <th>บทบาท</th>
                        <th>เข้าร่วมเมื่อ</th>
                        {% if current_user_role == 'admin' %}
                        <th>การจัดการ</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for member in member_roles %}
                    <tr>
                        <td>
                            {% if member.line_profile_url %}
                            <img src="{{ member.line_profile_url }}" alt="{{ member.username }}" class="rounded-circle" width="40" height="40">
                            {% else %}
                            <i class="fas fa-user-circle fa-2x text-secondary"></i>
                            {% endif %}
                        </td>
                        <td>{{ member.username }}</td>
                        <td>
                            {% if member.line_id %}
                            <i class="fab fa-line text-success me-1"></i> เชื่อมต่อแล้ว
                            {% else %}
                            <span class="text-muted">ยังไม่ได้เชื่อมต่อ</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if member.role == 'admin' %}
                            <span class="badge bg-danger">แอดมิน</span>
                            {% elif member.role == 'member' %}
                            <span class="badge bg-primary">สมาชิก</span>
                            {% else %}
                            <span class="badge bg-secondary">ผู้ชม</span>
                            {% endif %}
                        </td>
                        <td>{{ member.joined_at.split(' ')[0] if member.joined_at else '' }}</td>
                        {% if current_user_role == 'admin' and member.id != current_user.id %}
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    เปลี่ยนบทบาท
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <form action="{{ url_for('organization.change_role', org_id=organization.id, user_id=member.id) }}" method="post">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="role" value="admin">
                                            <button type="submit" class="dropdown-item {% if member.role == 'admin' %}active{% endif %}">
                                                <i class="fas fa-user-cog me-2"></i>แอดมิน
                                            </button>
                                        </form>
                                    </li>
                                    <li>
                                        <form action="{{ url_for('organization.change_role', org_id=organization.id, user_id=member.id) }}" method="post">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="role" value="member">
                                            <button type="submit" class="dropdown-item {% if member.role == 'member' %}active{% endif %}">
                                                <i class="fas fa-user-edit me-2"></i>สมาชิก
                                            </button>
                                        </form>
                                    </li>
                                    <li>
                                        <form action="{{ url_for('organization.change_role', org_id=organization.id, user_id=member.id) }}" method="post">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="role" value="viewer">
                                            <button type="submit" class="dropdown-item {% if member.role == 'viewer' %}active{% endif %}">
                                                <i class="fas fa-user me-2"></i>ผู้ชม
                                            </button>
                                        </form>
                                    </li>
                                </ul>

                                <button type="button" class="btn btn-sm btn-outline-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#removeMemberModal"
                                        data-user-id="{{ member.id }}"
                                        data-username="{{ member.username }}"
                                        data-email="{{ member.email }}">
                                    <i class="fas fa-user-minus"></i>
                                </button>
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal สำหรับลบสมาชิก -->
{% if current_user_role == 'admin' %}
<div class="modal fade" id="removeMemberModal" tabindex="-1" aria-labelledby="removeMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="removeMemberModalLabel">ยืนยันการลบสมาชิก</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>คุณต้องการลบ <span id="memberUsername"></span> ออกจากองค์กรใช่หรือไม่?</p>
                <p class="text-danger">การดำเนินการนี้ไม่สามารถเรียกคืนได้</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <form id="removeMemberForm" action="" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">ยืนยันการลบ</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal สำหรับเชิญผ่าน LINE -->
<div class="modal fade" id="inviteLineModal" tabindex="-1" aria-labelledby="inviteLineModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="inviteLineModalLabel"><i class="fab fa-line me-2"></i>เชิญสมาชิกผ่าน LINE</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('organization.generate_invite', id=organization.id) }}" method="post" id="inviteLineForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="mb-3">
                        <label class="form-label">เลือกบทบาทสำหรับผู้ที่จะเข้าร่วม</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="role" id="role-admin" value="admin">
                                    <label class="form-check-label" for="role-admin">
                                        <span class="badge bg-danger mb-1">แอดมิน</span>
                                        <p class="form-text mb-0">จัดการได้ทุกอย่าง รวมถึงสมาชิกและการตั้งค่าองค์กร</p>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="role" id="role-member" value="member" checked>
                                    <label class="form-check-label" for="role-member">
                                        <span class="badge bg-primary mb-1">สมาชิก</span>
                                        <p class="form-text mb-0">เพิ่มและแก้ไขรายการได้ จัดการข้อมูลพื้นฐานได้</p>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="role" id="role-viewer" value="viewer">
                                    <label class="form-check-label" for="role-viewer">
                                        <span class="badge bg-secondary mb-1">ผู้ชม</span>
                                        <p class="form-text mb-0">ดูข้อมูลได้อย่างเดียว ไม่สามารถแก้ไขหรือเพิ่มรายการได้</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        ระบบจะสร้างลิงก์เชิญที่สามารถแชร์ผ่าน LINE หรือช่องทางอื่นๆ ได้ ผู้รับเชิญไม่จำเป็นต้องมีบัญชีในระบบก่อน
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="fab fa-line me-1"></i> สร้างลิงก์เชิญ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- คำอธิบายบทบาท -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>คำอธิบายบทบาทในองค์กร</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="card h-100 bg-danger bg-opacity-10">
                    <div class="card-body">
                        <h5><i class="fas fa-user-cog me-2"></i>แอดมิน</h5>
                        <ul class="small mb-0">
                            <li>จัดการสมาชิกในองค์กร</li>
                            <li>เชิญและลบสมาชิก</li>
                            <li>กำหนดบทบาทของสมาชิก</li>
                            <li>แก้ไขข้อมูลองค์กร</li>
                            <li>จัดการรายรับรายจ่ายทั้งหมด</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 bg-primary bg-opacity-10">
                    <div class="card-body">
                        <h5><i class="fas fa-user-edit me-2"></i>สมาชิก</h5>
                        <ul class="small mb-0">
                            <li>ดูข้อมูลรายรับรายจ่ายทั้งหมด</li>
                            <li>เพิ่มรายรับรายจ่าย</li>
                            <li>แก้ไขและลบรายการที่ตัวเองสร้าง</li>
                            <li>สร้างและจัดการบัญชี</li>
                            <li>สร้างและจัดการหมวดหมู่</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 bg-secondary bg-opacity-10">
                    <div class="card-body">
                        <h5><i class="fas fa-user me-2"></i>ผู้ชม</h5>
                        <ul class="small mb-0">
                            <li>ดูข้อมูลรายรับรายจ่ายทั้งหมด</li>
                            <li>ดูรายงานต่างๆ</li>
                            <li>ไม่สามารถเพิ่ม แก้ไข หรือลบรายการได้</li>
                            <li>ไม่สามารถจัดการบัญชีและหมวดหมู่ได้</li>
                            <li>เหมาะสำหรับผู้ตรวจสอบบัญชี</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // สคริปต์สำหรับ Modal ลบสมาชิก
    const removeMemberModal = document.getElementById('removeMemberModal');
    if (removeMemberModal) {
        removeMemberModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-user-id');
            const username = button.getAttribute('data-username');

            // อัปเดตข้อมูลใน Modal
            document.getElementById('memberUsername').textContent = username;

            // อัปเดต URL ของฟอร์ม
            document.getElementById('removeMemberForm').action = "{{ url_for('organization.remove_member', org_id=organization.id, user_id=0) }}".replace('0', userId);
        });
    }
});
</script>
{% endblock %}